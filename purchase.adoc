## Purchase API

### URL
Test:: https://purchase-pa.izettletest.com
Production:: https://purchase.izettle.com

### Get purchase history
Will include cash register information if possible.

`GET purchases`

lastPurchaseHash (optional):: A value from "lastPurchaseHash" from the result of a previous history query, to continue listing purchases from the next record after the previous query.
startDate (optional):: Start date for purchases to be retrieved from, and including, this day until today or endDate. Can only be combined with endDate.
endDate (optional):: Last date, inclusive, for purchases to be retrieved until. Can only be combined with startDate.
limit (optional):: The maximum number of records to return.
descending (optional):: When true, returns purchases with the highest timestamp first.  When false, returns purchases with the lowest timestamp first. Defaults to false if not specified.

Fields named "*UUID1" are the standard UUID Type 1 (8-4-4-4-12) representation of the UUID fields.  The UUID fields can be either of:

1. Base64 encoded UUID. 
2. A Long purchase ID. This is the case for purchases several years old and in these cases there can be no UUID representation so the *UUID1 fields will be null

#### Permissions required
`READ:PURCHASE`

#### Example response
`GET purchases?limit=10`
```json
{
  "purchases": [
    {
      "purchaseUUID": "6HbDrnUNRji5iniGikNLiQ",
      "purchaseUUID1" : "fe8d0460-21c4-11e6-8ca8-3a4023ced819",
      "amount": 1500,
      "vatAmount": 161,
      "country": "SE",
      "currency": "SEK",
      "timestamp": "2015-02-08T10:21:21.469+0000",
      "gpsCoordinates": {
        "longitude": 18.44447366482676,
        "latitude": 60.416075632611964,
        "accuracyMeters": 65
      },
      "purchaseNumber": 1,
      "userDisplayName": "Elna Westman",
      "userId": 1713921,
      "organizationId": 14184411,
      "products": [
        {
          "quantity": "1",
          "nrOfUnits": 1, // DEPRECATED, use quantity instead.
          "revisionId": 86695765,
          "vatPercentage": 12,
          "unitPrice": 1500,
          "name": "Enkel espresso",
          "productId": 32704190,
          "autoGenerated": false,
          "libraryProduct": true
        }
      ],
      "cardPayments": [
        {
          "cardPaymentUUID": "aDvfSXWDRb-NmbbwMegqdA",
          "cardPaymentUUID1": "683bdf49-7583-45bf-8d99-b6f031e82a74",
          "amount": 1500,
          "cardType": "MASTERCARD",
          "maskedPan": "518779******5289",
          "cardPaymentEntryMode": "EMV",
          "applicationIdentifier": "A0000000041010",
          "terminalVerificationResults": "0000008000",
          "transactionStatusInformation": "E800",
          "referenceNumber": "N4GVFINIER",
          "nrOfInstallments": 0
        }
      ],
      "cashRegister": {
        "uuid": "r_dBcr6tT2ypC1jlMuUUzg",
        "displayName": "Kassa 1"
      },
      "receiptCopyAllowed": true,
      "groupedVatAmounts": {
        "12.0": 1500
      },
      "refund": false,
      "refunded": false
    },
    {
      "purchaseUUID": "zj9yI1wyTvqP46AG8NEaYg",
      "purchaseUUID1" : "ce3f7223-5c32-4efa-8fe3-a006f0d11a62",
      "amount": 1500,
      "vatAmount": 161,
      "country": "SE",
      "currency": "SEK",
      "timestamp": "2015-02-08T10:22:08.355+0000",
      "gpsCoordinates": {
        "longitude": 17.53335989364865,
        "latitude": 58.772674182845805,
        "accuracyMeters": 65
      },
      "purchaseNumber": 2,
      "userDisplayName": "Elna Westman",
      "userId": 1713921,
      "organizationId": 14184411,
      "products": [
        {
          "quantity": "1",
          "nrOfUnits": 1, // DEPRECATED, use quantity instead.
          "revisionId": 86695765,
          "vatPercentage": 12,
          "unitPrice": 1500,
          "name": "Enkel espresso",
          "productId": 32704190,
          "autoGenerated": false,
          "libraryProduct": true
        }
      ],
      "cashPayments": [
        {
          "cashPaymentUUID": "54f3gL8aToKG10bXOfj-IQ",
          "amount": 1500,
          "handedAmount": 10000
        }
      ],
      "cashRegister": {
        "uuid": "r_dBcr6tT2ypC1jlMuUUzg",
        "displayName": "Kassa 1"
      },
      "receiptCopyAllowed": true,
      "groupedVatAmounts": {
        "12.0": 1500
      },
      "refund": false,
      "refunded": false
    }
  ],
  "firstPurchaseHash": "14233908814696HbDrnUNRji5iniGikNLiQ",
  "lastPurchaseHash": "1423390928355zj9yI1wyTvqP46AG8NEaYg"
}
```

#### How to load all purchases for a user

You should never retrieve all the purchases in one request, since that can potentially but to much load on the server causing the request to be rejected or time out.

Instead, you should request the purchases splitted up into "pages", using the `limit` and `lastPurchaseHash` parameters.

The `limit` parameter will set the page size, and the `lastPurchaseHash` parameter sets the starting point from where to retrieve purchases. Every response from the purchase service will contain a `lastPurchaseHash` field, which can be added to the new request to retrieve the next "page".

In order to load all purchases, begin with an initial request without the `lastPurchaseHash` parameter being set, this will retrieve the first _n_ purchases (where _n_ is the page size defined by the `limit` parameter):

```
GET /purchases?limit=100
```

The result will contain the first _n_ number of purchases.
```
{
  "purchases": [
    ....
  ],
  "firstPurchaseHash": "14233908814696HbDrnUNRji5iniGikNLiQ",
  "lastPurchaseHash": "1423390928355zj9yI1wyTvqP46AG8NEaYg"
}
```

To retrieve the following pages, use the `lastPurchaseHash` field in the previous response to load the next page:
```
GET /purchases?limit=100&lastPurchaseHash=1423390928355zj9yI1wyTvqP46AG8NEaYg
```

The result will contain the next _n_ number of purchases:
```
{
  "purchases": [
    ....
  ],
  "firstPurchaseHash": "1423390928355zj9yI1wyTvqP46AG8NEaYg",
  "lastPurchaseHash": "1426265546490RPXdoMmDEeSg5Gw_2s_ZrQ"
}
```

Continue this process by using the `lastPurchaseHash` in the previous response as a request parameter in the following request until you receive an empty result.

If you want to be able to load new purchases later on, then store the last used `lastPurchaseHash` and use that to continue retrieving new purchases at a later time.

### Get purchase details

`GET purchase/{purchaseUUID}`

#### Permissions required
`READ:PURCHASE`

purchaseUUID:: The UUID of the purchase

#### Errors
404:: Purchase not found

#### Example response
`GET purchase/6HbDrnUNRji5iniGikNLiQ`
```json
{
    "purchaseUUID": "6HbDrnUNRji5iniGikNLiQ",
    "purchaseUUID1" : "e876c3ae-750d-4638-b98a-78868a434b89",
    "amount": 1500,
    "vatAmount": 161,
    "country": "SE",
    "currency": "SEK",
    "timestamp": "2015-02-08T10:21:21.469+0000",
    "gpsCoordinates": {
        "longitude": -73.99845698202617,
        "latitude": 40.734215418008596,
        "accuracyMeters": 65
    },
    "purchaseNumber": 1,
    "userDisplayName": "Stig Haraldsson",
    "products": [
        {
            "quantity": "1",
            "nrOfUnits": 1, // DEPRECATED, use quantity instead.
            "revisionId": 86695765,
            "vatPercentage": 12,
            "unitPrice": 1500,
            "name": "Enkel espresso",
            "productId": 32704190,
            "autoGenerated": false,
            "libraryProduct": true
        }
    ],
    "cardPayments": [
        {
            "cardPaymentUUID": "aDvfSXWDRb-NmbbwMegqdA",
            "cardPaymentUUID1": "683bdf49-7583-45bf-8d99-b6f031e82a74",
            "amount": 1500,
            "cardType": "MASTERCARD",
            "maskedPan": "540200******7008",
            "cardPaymentEntryMode": "EMV",
            "applicationIdentifier": "A0000000041010",
            "terminalVerificationResults": "0000008000",
            "transactionStatusInformation": "E800",
            "referenceNumber": "N4GVFINIER",
            "nrOfInstallments": 0
        }
    ],
    "cashRegister": {
        "uuid": "r_dBcr6tT2ypC1jlMuUUzg",
        "displayName": "Kassa 1"
    },
    "receiptCopyAllowed": true,
    "refund": false,
    "groupedVatAmounts": {
        "12.0": 1500
    },
    "refunded": false
}
```
